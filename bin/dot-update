#!/usr/bin/env bash

# Set error handling
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

info "Updating dotfiles..."

info "1/4: Updating Homebrew and installed packages..."
if command -v brew &> /dev/null; then
    brew update

    # 先列出即将升级的包，让用户确认
    # 2>/dev/null: 屏蔽 brew 对有问题 cask（如已废弃包）产生的 Error 行，避免 set -e 误中断
    # || true: 同理，brew outdated 在存在问题 cask 时会返回非零退出码
    OUTDATED=$(brew outdated --quiet 2>/dev/null || true)
    if [ -z "$OUTDATED" ]; then
        success "Homebrew: 所有包已是最新版本。"
    else
        echo ""
        echo "以下 Homebrew 包将被升级："
        echo "$OUTDATED" | sed 's/^/  /'
        echo ""
        read -r -p "确认升级以上包？[y/N] " confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
            brew upgrade
            success "Homebrew updated."
        else
            info "已跳过 Homebrew 升级。"
        fi
    fi
else
    error "Homebrew not found, skipping."
fi

info "2/4: Updating Mise and its managed tools..."
if command -v mise &> /dev/null; then
    mise upgrade
    success "Mise updated."
else
    error "Mise not found, skipping."
fi

info "3/4: Updating Fisher and its plugins..."
if command -v fish &> /dev/null; then
    if fish -c "type -q fisher" 2>/dev/null; then
        fish -c "fisher update"
        success "Fisher updated."
    else
        error "Fisher not installed in fish, skipping."
    fi
else
    error "Fish not found, skipping."
fi

info "4/4: Updating Tree-sitter grammars for Helix..."
if command -v hx &> /dev/null; then
    hx --grammar fetch
    hx --grammar build
    success "Helix grammars updated."
else
    error "Helix not found, skipping."
fi

success "Dotfiles and tools updated successfully!"
