#!/usr/bin/env bash

# Set error handling
set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

info "Updating dotfiles..."

info "1/4: Updating Homebrew and installed packages..."
if command -v brew &> /dev/null; then
    brew update
    brew upgrade
    success "Homebrew updated."
else
    error "Homebrew not found, skipping."
fi

info "2/4: Updating Mise and its managed tools..."
if command -v mise &> /dev/null; then
    mise upgrade
    success "Mise updated."
else
    error "Mise not found, skipping."
fi

info "3/4: Updating Fisher and its plugins..."
if command -v fish &> /dev/null; then
    if fish -c "type -q fisher" 2>/dev/null; then
        fish -c "fisher update"
        success "Fisher updated."
    else
        error "Fisher not installed in fish, skipping."
    fi
else
    error "Fish not found, skipping."
fi

info "4/4: Updating Tree-sitter grammars for Helix..."
if command -v hx &> /dev/null; then
    hx --grammar fetch
    hx --grammar build
    success "Helix grammars updated."
else
    error "Helix not found, skipping."
fi

success "Dotfiles and tools updated successfully!"
