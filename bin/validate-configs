#!/usr/bin/env bash
# validate-configs
#
# 验证 dotfiles 配置文件的语法和完整性
# 用法: validate-configs [fish|git|zellij|helix|all]

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[✓]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[✗]${NC} $1"; }

# 尝试多种方式获取 dotfiles 目录
# 1. 环境变量（优先级最高）
# 2. 从脚本位置推断（bin/validate-configs -> dotfiles/）
# 3. 从 git 仓库位置推断
if [ -n "${DOTFILES_DIR:-}" ]; then
    : # 使用环境变量
elif [ -d "$(dirname "${BASH_SOURCE[0]}")/../.git" ]; then
    DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
elif git -C "$(dirname "${BASH_SOURCE[0]}")/.." rev-parse --is-inside-work-tree &>/dev/null; then
    DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
else
    # 默认值
    DOTFILES_DIR="$HOME/dotfiles"
fi
ERRORS=0

# Python TOML 验证脚本
validate_toml_file() {
    local file="$1"
    if [ ! -f "$file" ]; then
        return 0
    fi
    
    python3 -c "
import sys
import warnings
warnings.filterwarnings('ignore')

try:
    import tomllib
except ImportError:
    try:
        import tomli as tomllib
    except ImportError:
        print('TOML 验证跳过: Python < 3.11 且未安装 tomli 库')
        sys.exit(0)  # Python < 3.11 且无 tomli，跳过验证

try:
    with open('$file', 'rb') as f:
        tomllib.load(f)
except Exception as e:
    print(f'$file: TOML 语法错误: {e}')
    sys.exit(1)
" || return 1
    return 0
}

# 验证 Fish 配置
validate_fish() {
    info "验证 Fish 配置..."
    local fish_config="$DOTFILES_DIR/fish/dot-config/fish/config.fish"
    
    if [ ! -f "$fish_config" ]; then
        error "Fish 配置文件不存在: $fish_config"
        return 1
    fi
    
    if command -v fish &>/dev/null; then
        if fish -n "$fish_config" 2>/dev/null; then
            success "Fish 配置语法正确"
        else
            error "Fish 配置存在语法错误"
            ERRORS=$((ERRORS + 1))
        fi
    else
        warn "Fish 未安装，跳过语法检查"
    fi
}

# 验证 Git 配置
validate_git() {
    info "验证 Git 配置..."
    local git_config="$DOTFILES_DIR/git/dot-gitconfig"
    
    if [ ! -f "$git_config" ]; then
        error "Git 配置文件不存在: $git_config"
        return 1
    fi
    
    # Git 配置格式检查
    if git config --file="$git_config" --list &>/dev/null; then
        success "Git 配置格式正确"
    else
        error "Git 配置存在格式错误"
        ERRORS=$((ERRORS + 1))
    fi
}

# 验证 Zellij 配置
validate_zellij() {
    info "验证 Zellij 配置..."
    local zellij_config="$DOTFILES_DIR/zellij/dot-config/zellij/config.kdl"
    
    if [ ! -f "$zellij_config" ]; then
        error "Zellij 配置文件不存在: $zellij_config"
        return 1
    fi
    
    if command -v zellij &>/dev/null; then
        if zellij setup --check &>/dev/null; then
            success "Zellij 配置正确"
        else
            warn "Zellij 配置检查返回警告（可能不影响使用）"
        fi
    else
        warn "Zellij 未安装，跳过配置检查"
    fi
}

# 验证 Helix 配置
validate_helix() {
    info "验证 Helix 配置..."
    local helix_config="$DOTFILES_DIR/helix/dot-config/helix/config.toml"
    local helix_languages="$DOTFILES_DIR/helix/dot-config/helix/languages.toml"
    
    # 检查配置文件是否存在
    if [ ! -f "$helix_config" ]; then
        error "Helix 配置文件不存在: $helix_config"
        ERRORS=$((ERRORS + 1))
    else
        # 静态 TOML 检查
        if validate_toml_file "$helix_config"; then
            success "Helix 主配置语法正确 (TOML)"
        else
            error "Helix 主配置语法错误"
            ERRORS=$((ERRORS + 1))
        fi
    fi
    
    if [ -f "$helix_languages" ]; then
         # 静态 TOML 检查
        if validate_toml_file "$helix_languages"; then
            success "Helix 语言配置语法正确 (TOML)"
        else
            error "Helix 语言配置语法错误"
            ERRORS=$((ERRORS + 1))
        fi
    fi
    
    # 如果 helix 已安装，运行健康检查
    if command -v hx &>/dev/null; then
        info "Helix 健康状态:"
        hx --health 2>/dev/null | head -20 || true
    else
        warn "Helix 未安装，跳过健康检查"
    fi
}

# 验证 Mise 配置
validate_mise() {
    info "验证 Mise 配置..."
    local mise_config="$DOTFILES_DIR/mise/dot-config/mise/config.toml"
    
    if [ ! -f "$mise_config" ]; then
        error "Mise 配置文件不存在: $mise_config"
        return 1
    fi

    # 静态 TOML 检查
    if validate_toml_file "$mise_config"; then
        success "Mise 配置语法正确 (TOML)"
    else
        error "Mise 配置语法错误"
        ERRORS=$((ERRORS + 1))
    fi
    
    if command -v mise &>/dev/null; then
        if mise ls &>/dev/null; then
            success "Mise 配置可正常读取"
        else
            warn "Mise 配置可能有警告（工具未安装不影响配置有效性）"
        fi
    else
        warn "Mise 未安装，跳过配置检查"
    fi
}

# 验证 Ghostty 配置
validate_ghostty() {
    info "验证 Ghostty 配置..."
    local ghostty_config="$DOTFILES_DIR/ghostty/dot-config/ghostty/config"
    
    if [ ! -f "$ghostty_config" ]; then
        error "Ghostty 配置文件不存在: $ghostty_config"
        return 1
    fi

    # 优先使用 ghostty CLI 进行验证
    if command -v ghostty &>/dev/null; then
        # 捕获输出，只显示错误信息
        if output=$(ghostty +validate-config --config-file="$ghostty_config" 2>&1); then
            success "Ghostty 配置验证通过 (CLI)"
        else
            error "Ghostty 配置验证失败:"
            echo "$output" | sed 's/^/    /' # 缩进输出
            ERRORS=$((ERRORS + 1))
        fi
    else
        # 降级方案：简单的 grep 检查
        warn "Ghostty CLI 未找到，使用基础检查..."
        if grep -q "^font-family" "$ghostty_config" && grep -q "^theme" "$ghostty_config"; then
            success "Ghostty 配置文件包含必要配置项"
        else
            warn "Ghostty 配置可能缺少关键配置项"
        fi
    fi
}

# 验证自定义脚本
validate_bin_scripts() {
    info "验证自定义脚本..."
    local bin_dir="$DOTFILES_DIR/bin"
    local script_errors=0
    
    for script in "$bin_dir"/*; do
        if [ -f "$script" ] && [ -x "$script" ]; then
            local script_name
            script_name=$(basename "$script")
            # 检查 shebang
            if head -1 "$script" | grep -q "^#!/"; then
                success "$script_name - shebang 正确"
            else
                warn "$script_name - 缺少 shebang"
            fi
        fi
    done
}

# 主逻辑
main() {
    local target="${1:-all}"
    
    echo "========================================"
    echo "  Dotfiles 配置验证"
    echo "  目录: $DOTFILES_DIR"
    echo "========================================"
    echo
    
    case "$target" in
        fish)
            validate_fish
            ;;
        git)
            validate_git
            ;;
        zellij)
            validate_zellij
            ;;
        helix)
            validate_helix
            ;;
        mise)
            validate_mise
            ;;
        ghostty)
            validate_ghostty
            ;;
        all)
            validate_fish
            validate_git
            validate_zellij
            validate_helix
            validate_mise
            validate_ghostty
            validate_bin_scripts
            ;;
        *)
            echo "用法: validate-configs [fish|git|zellij|helix|mise|ghostty|all]"
            exit 1
            ;;
    esac
    
    echo
    echo "========================================"
    if [ $ERRORS -eq 0 ]; then
        success "验证完成，未发现错误"
        exit 0
    else
        error "验证完成，发现 $ERRORS 个错误"
        exit 1
    fi
}

main "$@"
