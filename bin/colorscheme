#!/usr/bin/env bash
# colorscheme
#
# Switch colorscheme for Ghostty, Helix and Zellij simultaneously.
#
# Requirements:
#   brew install gnu-sed
#
# Adding a new theme:
#   Just add a line to the THEMES array below. Format:
#   "shortname|Ghostty Theme Name|helix_theme_name|zellij-theme-name"

set -euo pipefail

# ============================================
# Theme Registry (single source of truth)
# Format: "shortname|ghostty|helix|zellij"
# If a tool's theme name matches the shortname, use '=' as a placeholder.
#
# Ghostty theme names: run `ghostty +list-themes` to list all available themes.
# Helix theme names: run `hx --health` or check ~/.config/helix/runtime/themes/.
# Zellij theme names: check built-in themes in zellij docs.
# ============================================
THEMES=(
    "dracula|Dracula|=|="
    "tokyonight|TokyoNight Moon|tokyonight_moon|tokyo-night"
    "gruvbox|Gruvbox Material Dark|gruvbox_dark_hard|="
    "catppuccin|Catppuccin Mocha|catppuccin_mocha|catppuccin-mocha"
    "kanagawa|Kanagawa Wave|kanagawa|="
    "nord|Nord|nord|nord"
    "rose-pine|Rose Pine|rose_pine|="
    "solarized-dark|Solarized Dark Higher Contrast|solarized_dark|="
    "one-dark|Atom One Dark|one_dark|="
    "everforest|Everforest Dark Hard|everforest_dark|="
)

# Check for gsed (GNU sed)
if command -v gsed &>/dev/null; then
    SED=gsed
elif command -v sed &>/dev/null; then
    SED=sed
else
    echo "Error: sed not found" >&2
    exit 1
fi

config_home=${XDG_CONFIG_HOME:-"$HOME/.config"}

ghostty_config="$config_home/ghostty/config"
helix_config="$config_home/helix/config.toml"
zellij_config="$config_home/zellij/config.kdl"

# Show current theme from config files
show_current() {
    echo "当前主题:"
    if [ -f "$ghostty_config" ]; then
        local gt
        gt=$(grep -E '^theme\s*=' "$ghostty_config" | $SED -E 's/^theme\s*=\s*"?([^"]*)"?\s*$/\1/' | head -1)
        echo "  Ghostty : ${gt:-未设置}"
    fi
    if [ -f "$helix_config" ]; then
        local ht
        ht=$(grep -E '^theme\s*=' "$helix_config" | $SED -E 's/^theme\s*=\s*"?([^"]*)"?\s*$/\1/' | head -1)
        echo "  Helix   : ${ht:-未设置}"
    fi
    if [ -f "$zellij_config" ]; then
        local zt
        zt=$(grep -E '^theme\s' "$zellij_config" | $SED -E 's/^theme\s+"?([^"]*)"?\s*$/\1/' | head -1)
        echo "  Zellij  : ${zt:-未设置}"
    fi
}

# List available themes
list_themes() {
    echo ""
    echo "可用主题:"
    for entry in "${THEMES[@]}"; do
        IFS='|' read -r name _ _ _ <<< "$entry"
        echo "  $name"
    done
}

colorscheme=${1:-}

if [ -z "$colorscheme" ]; then
    show_current
    list_themes
    echo ""
    echo "用法: colorscheme <name>"
    echo "提示: 不在列表中的名称会直接透传给各工具（适用于工具原生主题名）。"
    exit 0
fi

# Lookup theme name for a specific tool.
# $1 = shortname, $2 = field index (1=ghostty, 2=helix, 3=zellij)
lookup_theme() {
    local name="$1" field="$2"
    for entry in "${THEMES[@]}"; do
        IFS='|' read -r entry_name ghostty helix zellij <<< "$entry"
        if [ "$entry_name" = "$name" ]; then
            local values=("$entry_name" "$ghostty" "$helix" "$zellij")
            local result="${values[$field]}"
            # '=' means same as shortname
            if [ "$result" = "=" ]; then
                echo "$name"
            else
                echo "$result"
            fi
            return
        fi
    done
    # Not found in registry, passthrough as-is
    echo "$name"
}

ghostty_cs_change() {
    if [ ! -f "$ghostty_config" ]; then
        echo "ghostty config not found: $ghostty_config" >&2
        return 1
    fi

    local theme
    theme=$(lookup_theme "$colorscheme" 1)
    $SED -i -E "s/^theme\s*=.*/theme = \"$theme\"/" "$ghostty_config"
    echo "Ghostty theme -> $theme"
}

helix_cs_change() {
    if [ ! -f "$helix_config" ]; then
        echo "helix config not found: $helix_config" >&2
        return 1
    fi

    local theme
    theme=$(lookup_theme "$colorscheme" 2)
    $SED -i -E "s/^theme\s*=.*/theme = \"$theme\"/" "$helix_config"
    echo "Helix  theme -> $theme"
}

zellij_cs_change() {
    if [ ! -f "$zellij_config" ]; then
        echo "zellij config not found: $zellij_config" >&2
        return 1
    fi

    local theme
    theme=$(lookup_theme "$colorscheme" 3)
    $SED -i -E "s/^theme\s+\"[^\"]*\"/theme \"$theme\"/" "$zellij_config"
    echo "Zellij theme -> $theme"
}

ghostty_cs_change
helix_cs_change
zellij_cs_change

exit 0
